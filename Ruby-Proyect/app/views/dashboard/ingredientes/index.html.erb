<section>
  <h2>Lista de Ingredientes</h2>

  <div style="display: flex; justify-content: space-between; align-items: center; flex-direction: row; margin-bottom: 20px;">
      <%= link_to "Nuevo Ingrediente", new_dashboard_ingrediente_path, class: "btn-aggr" %>
      <%= form_with url: dashboard_ingredientes_path, method: :get, local: true, html: {class: "buscador"} do %>
          <%= search_field_tag :query, params[:query], placeholder: "Buscar ingrediente...", autocomplete: "off", id: "buscador-ingredientes" %>
      <% end %>
  </div>
  <br>

  <% if @ingredientes_paginado.any? %>
    <% @ingredientes_paginado.each do |ingrediente| %>
      <div class="dashboard-ingrediente" data-nombre="<%= I18n.transliterate(ingrediente.nombre.downcase) %>">
        <div class="grupo-info-dashboard">
          <strong><%= ingrediente.nombre %></strong>
          <p>/</p>
          <p>Id: <%= ingrediente.id %></p>
          <p>/</p>
          <% 
            nivel = ingrediente.nivel_stock
            color_clase = case nivel
                          when :agotado then 'stock-agotado'
                          when :muy_bajo then 'stock-muy-bajo'
                          when :bajo then 'stock-bajo'
                          else 'stock-normal'
                          end
            icono = case nivel
                    when :agotado then 'ðŸ”´'
                    when :muy_bajo then 'ðŸŸ '
                    when :bajo then 'ðŸŸ¡'
                    else 'ðŸŸ¢'
                    end
            texto_estado = case nivel
                           when :agotado then 'AGOTADO'
                           when :muy_bajo then 'MUY BAJO'
                           when :bajo then 'BAJO'
                           else 'NORMAL'
                           end
          %>
          <span class="stock-badge <%= color_clase %>">
            <%= icono %> <%= texto_estado %>
          </span>
        </div>
        <div class="dashboard-acciones">
          <button onclick="abrirModalStock(<%= ingrediente.id %>, '<%= ingrediente.nombre %>', <%= ingrediente.stock %>)" class="btn-stock">
            ðŸ“¦ Actualizar Stock
          </button>
          <%= link_to "Editar", edit_dashboard_ingrediente_path(ingrediente), class: "btn-editar" %>
          <%= button_to "Eliminar", dashboard_ingrediente_path(ingrediente), method: :delete, data: { confirm: "Â¿EstÃ¡s seguro de que quieres eliminar este Ingrediente?" }, class: "btn-eliminar" %>
        </div>
      </div>
    <% end %>

    <div id="sin-resultados-ingredientes" style="display: none; text-align: center; margin-top: 20px; color: gray;">
      No se encontraron ingredientes.
    </div>
  <% else %>
    <div style="text-align: center; margin-top: 20px; color: gray;">
      No hay ingredientes registrados.
    </div>
  <% end %>
  <%= paginate @ingredientes_paginado %>
</section>

<!-- Modal para actualizar stock -->
<div id="modalStock" class="modal-stock" style="display: none;">
  <div class="modal-stock-content">
    <span class="modal-stock-close" onclick="cerrarModalStock()">&times;</span>
    <h3>Actualizar Stock: <span id="modalIngredienteNombre"></span></h3>
    <p>Stock actual: <strong id="modalStockActual"></strong></p>
    
    <%= form_with url: "", method: :post, local: true, id: "formActualizarStock" do |f| %>
      <div style="margin: 20px 0;">
        <%= label_tag :cantidad, "Cantidad:" %>
        <%= number_field_tag :cantidad, nil, min: 0.01, step: 0.01, required: true, style: "width: 100%; padding: 8px; margin-top: 5px;" %>
      </div>
      
      <div style="margin: 20px 0;">
        <%= label_tag :tipo, "Tipo de operaciÃ³n:" %>
        <div style="margin-top: 10px;">
          <%= radio_button_tag :tipo, "agregar", true %>
          <%= label_tag :tipo_agregar, "âž• Agregar (Reabastecer)", style: "margin-right: 20px;" %>
          
          <%= radio_button_tag :tipo, "reducir" %>
          <%= label_tag :tipo_reducir, "âž– Reducir (Consumo)" %>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <%= submit_tag "Actualizar Stock", class: "btn-stock", style: "flex: 1;" %>
        <button type="button" onclick="cerrarModalStock()" class="btn-cancelar" style="flex: 1;">Cancelar</button>
      </div>
    <% end %>
  </div>
</div>

<style>
  .stock-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.9em;
    font-weight: bold;
  }
  .stock-normal { background-color: #d4edda; color: #155724; }
  .stock-bajo { background-color: #fff3cd; color: #856404; }
  .stock-muy-bajo { background-color: #f8d7da; color: #721c24; }
  .stock-agotado { background-color: #f5c6cb; color: #721c24; font-weight: bold; }
  
  .btn-stock {
    background-color: #17a2b8;
    color: white;
    padding: 8px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
  }
  .btn-stock:hover { background-color: #138496; }
  
  .btn-cancelar {
    background-color: #6c757d;
    color: white;
    padding: 8px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  .btn-cancelar:hover { background-color: #5a6268; }
  
  .modal-stock {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
  }
  
  .modal-stock-content {
    background-color: #fefefe;
    margin: 10% auto;
    padding: 30px;
    border: 1px solid #888;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  }
  
  .modal-stock-close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
  }
  .modal-stock-close:hover { color: #000; }
</style>

<script>
  document.addEventListener("turbo:load", function () {
    const input = document.getElementById("buscador-ingredientes");
    const cards = document.querySelectorAll(".dashboard-ingrediente");
    const mensaje = document.getElementById("sin-resultados-ingredientes");

    const normalizar = (str) =>
      str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

    input.addEventListener("input", function () {
      const valor = normalizar(input.value.trim());
      let visibles = 0;

      cards.forEach((card) => {
        const nombre = normalizar(card.dataset.nombre);
        const visible = nombre.includes(valor);
        card.style.display = visible ? "" : "none";
        if (visible) visibles++;
      });

      mensaje.style.display = visibles === 0 ? "block" : "none";
    });
  });
  
  function abrirModalStock(id, nombre, stockActual) {
    document.getElementById('modalIngredienteNombre').textContent = nombre;
    document.getElementById('modalStockActual').textContent = stockActual;
    
    const form = document.getElementById('formActualizarStock');
    form.action = '/dashboard/ingredientes/' + id + '/actualizar_stock';
    
    document.getElementById('modalStock').style.display = 'block';
  }
  
  function cerrarModalStock() {
    document.getElementById('modalStock').style.display = 'none';
    document.getElementById('formActualizarStock').reset();
  }
  
  // Cerrar modal al hacer clic fuera
  window.onclick = function(event) {
    const modal = document.getElementById('modalStock');
    if (event.target == modal) {
      cerrarModalStock();
    }
  }
</script>
