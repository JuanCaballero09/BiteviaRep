<div class="order-details-premium">
  <!-- Header de la orden -->
  <div class="order-header-modern">
    <div class="container-fluid">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h1 class="order-title-modern">
            <i class="fa-solid fa-receipt"></i>
            Orden <span class="order-code-highlight" id="order-code"><%= @order.code %></span>
          </h1>
          <p class="order-subtitle">Detalles completos de tu pedido</p>
        </div>
        <div class="col-md-4 text-md-end">
          <button class="copy-button-modern" onclick="copyOrderCode()" title="Copiar c√≥digo">
            <i class="fa-solid fa-copy"></i>
            Copiar c√≥digo
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Contenido principal -->
  <div class="order-content-modern">
    <div class="container-fluid">
      <div class="row g-4">
        
        <!-- Columna izquierda: Informaci√≥n y totales -->
        <div class="col-lg-4">
          <!-- Estado de la orden -->
          <div class="info-card-modern status-card">
            <div class="card-header-modern">
              <i class="fa-solid fa-chart-line"></i>
              <h3>Estado del Pedido</h3>
            </div>
            <div class="status-badge-large status-<%= @order.status.downcase.gsub(' ', '-') %>">
              <%= @order.status.humanize %>
            </div>
            <p class="status-description">
              <% case @order.status.downcase %>
              <% when 'pendiente' %>
                Tu pedido est√° esperando confirmaci√≥n de pago
              <% when 'en_preparacion' %>
                Estamos preparando tu pedido con mucho cuidado
              <% when 'terminado' %>
                Tu pedido est√° listo para ser enviado
              <% when 'en_transito' %>
                Tu pedido va en camino a tu ubicaci√≥n
              <% when 'entregado' %>
                ¬°Tu pedido ha sido entregado exitosamente!
              <% end %>
            </p>
          </div>

          <!-- Informaci√≥n del cliente -->
          <div class="info-card-modern">
            <div class="card-header-modern">
              <i class="fa-solid fa-user"></i>
              <h3><%= t("home.order.cliente") %></h3>
            </div>
            <p class="customer-name-modern"><%= @order.customer_name %></p>
          </div>

          <!-- Direcci√≥n de entrega -->
          <div class="info-card-modern">
            <div class="card-header-modern">
              <i class="fa-solid fa-location-dot"></i>
              <h3><%= t("home.order.direcci√≥n") %></h3>
            </div>
            <p class="address-text"><%= @order.direccion %></p>
          </div>

          <!-- M√©todo de pago -->
          <% payment = @order.payments.last %>
          <% if payment.present? %>
            <div class="info-card-modern">
              <div class="card-header-modern">
                <i class="fa-solid fa-credit-card"></i>
                <h3>M√©todo de Pago</h3>
              </div>
              <div class="payment-method-display">
                <% case payment.payment_method %>
                <% when 'card' %>
                  <i class="fa-solid fa-credit-card payment-icon"></i>
                  <span>Tarjeta <%= payment.type_card == 'credit' ? 'de Cr√©dito' : 'D√©bito' %></span>
                  <% if payment.installment.present? && payment.installment > 1 %>
                    <small>(<%= payment.installment %> cuotas)</small>
                  <% end %>
                <% when 'nequi' %>
                  <img src="/NequiLogo.png" alt="Nequi" class="payment-logo">
                  <span>Nequi</span>
                <% when 'pse' %>
                  <i class="fa-solid fa-building-columns payment-icon"></i>
                  <span>PSE</span>
                <% when 'cash' %>
                  <i class="fa-solid fa-money-bill payment-icon"></i>
                  <span>Efectivo</span>
                <% end %>
              </div>
            </div>
          <% end %>

          <!-- Total de la orden -->
          <div class="info-card-modern total-card-modern">
            <div class="card-header-modern">
              <i class="fa-solid fa-calculator"></i>
              <h3><%= t("home.order.tootal_paga") %></h3>
            </div>
            
            <div class="totales-breakdown">
              <% subtotal = @order.total - (@order.costo_domicilio || 0) %>
              <div class="total-line-item">
                <span>Subtotal productos:</span>
                <span class="precio-unitario" data-precio="<%= subtotal %>" data-locale="<%= I18n.locale %>"></span>
              </div>
              
              <% if @order.costo_domicilio.present? && @order.costo_domicilio > 0 %>
                <div class="total-line-item domicilio-line">
                  <span><i class="fa-solid fa-truck"></i> Costo de domicilio:</span>
                  <span class="precio-unitario" data-precio="<%= @order.costo_domicilio %>" data-locale="<%= I18n.locale %>"></span>
                </div>
              <% end %>
              
              <div class="total-line-item total-final-line">
                <span><strong>Total:</strong></span>
                <span class="precio-unitario total-price" data-precio="<%= @order.total %>" data-locale="<%= I18n.locale %>"></span>
              </div>
            </div>
            
            <% if @order.coupon.present? %>
              <div class="coupon-badge">
                <i class="fa-solid fa-tag"></i>
                Cup√≥n <%= @order.coupon.codigo %> aplicado
              </div>
            <% end %>
          </div>

          <!-- Botones de acci√≥n -->
          <div class="action-buttons-modern">
            <% if @order.status.downcase == 'pendiente' %>
              <%= link_to new_order_payments_path(@order), class: "btn-pagar-modern" do %>
                <i class="fa-solid fa-credit-card"></i>
                <%= t("home.order.pagar") %>
              <% end %>
            <% end %>
            
            <%= link_to clientes_path, class: "btn-volver-modern" do %>
              <i class="fa-solid fa-arrow-left"></i>
              <%= t("home.order.volver") %>
            <% end %>
          </div>
        </div>

        <!-- Columna derecha: Productos -->
        <div class="col-lg-8">
          <div class="products-section-modern">
            <div class="section-header-modern">
              <div>
                <h2>
                  <i class="fa-solid fa-utensils"></i>
                  <%= t("home.order.or_producto") %>
                </h2>
                <p class="items-count-text"><%= @order.order_items.count %> <%= @order.order_items.count != 1 ? 'productos' : 'producto' %></p>
              </div>
            </div>
            
            <div class="products-list-modern">
              <% @order.order_items.each_with_index do |order_item, index| %>
                <div class="product-card-modern <%= 'is-combo' if order_item.product.is_a?(Combo) %>">
                  <div class="product-main-info">
                    <div class="product-image-container">
                      <% 
                        # Determinar qu√© imagen mostrar
                        if order_item.product.respond_to?(:imagen) && order_item.product.imagen.attached?
                          image_url = url_for(order_item.product.imagen)
                        elsif order_item.product.respond_to?(:grupo) && order_item.product.grupo&.imagen&.attached?
                          image_url = order_item.product.grupo.imagen_resized.attached? ? url_for(order_item.product.grupo.imagen_resized) : url_for(order_item.product.grupo.imagen)
                        else
                          image_url = asset_path('LogoLogoText2.svg')
                        end
                        
                        product_name = order_item.product.nombre
                      %>
                      <img
                        src="<%= image_url %>"
                        alt="<%= product_name %>"
                        class="product-image"
                        onerror="this.src='<%= asset_path('LogoLogoText2.svg') %>'"
                      >
                      
                      <% if order_item.product.is_a?(Combo) %>
                        <div class="combo-badge">
                          <i class="fa-solid fa-box"></i>
                          <span>COMBO</span>
                        </div>
                      <% end %>
                    </div>
                    
                    <div class="product-details">
                      <div class="product-header">
                        <h3 class="product-name"><%= product_name %></h3>
                        <% if order_item.product.respond_to?(:grupo) && order_item.product.grupo %>
                          <div class="product-meta">
                            <span class="product-category">
                              <i class="fa-solid fa-tag"></i>
                              <%= order_item.product.grupo.nombre %>
                            </span>
                          </div>
                        <% end %>
                      </div>
                      
                      <div class="quantity-price-info">
                        <div class="quantity-container">
                          <span class="quantity-label">
                            <i class="fa-solid fa-hashtag"></i>
                            <%= t("home.order.cantidad")%>
                          </span>
                          <span class="quantity-value"><%= order_item.quantity %></span>
                        </div>
                        
                        <div class="price-container">
                          <div class="unit-price">
                            <span class="price-label"><%= t("home.order.precio_unitario")%></span>
                            <span class="price-value">
                              <strong class="precio-unitario" data-precio="<%= order_item.price %>" data-locale="<%= I18n.locale %>"></strong>
                            </span>
                          </div>
                          
                          <div class="total-price">
                            <span class="price-label">Subtotal:</span>
                            <span class="price-value total">
                              <% total_item = order_item.price * order_item.quantity %>
                              <strong class="precio-total"
                                data-precio="<%= total_item %>"
                                data-locale="<%= I18n.locale %>">
                                <% if I18n.locale == :en %>
                                  <%= number_to_currency(total_item / 4000, unit: "USD", format: "%n %u", precision: 2) %>
                                <% else %>
                                  <%= number_to_currency(total_item, unit: "COP", format: "%n %u", precision: 2) %>
                                <% end %>
                              </strong>
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Componentes del combo -->
                  <% if order_item.product.is_a?(Combo) && order_item.product.combo_items.any? %>
                    <div class="combo-components">
                      <div class="combo-header">
                        <h4 class="combo-title">
                          <i class="combo-icon">üì¶</i>
                          <%= t("home.clientes.componente_combo")%>
                        </h4>
                        <button class="toggle-combo" onclick="toggleComboDetails(<%= index %>)">
                          <span class="toggle-text"><%= t("home.clientes.ver_componentes")%></span>
                          <i class="toggle-arrow">‚ñº</i>
                        </button>
                      </div>
                      
                      <div class="combo-details" id="combo-details-<%= index %>" style="display: none;">
                        <div class="combo-items-grid">
                          <% order_item.product.combo_items.each do |combo_item| %>
                            <div class="combo-item">
                              <div class="combo-item-image">
                                <% if combo_item.product.imagen.attached? %>
                                  <%= image_tag combo_item.product.imagen, alt: combo_item.product.nombre, class: "combo-product-image" %>
                                <% else %>
                                  <%= image_tag 'LogoLogo.svg', alt: combo_item.product.nombre, class: "combo-product-image placeholder" %>
                                <% end %>
                              </div>
                              
                              <div class="combo-item-info">
                                <h5 class="combo-item-name"><%= combo_item.product.nombre %></h5>
                                <div class="combo-item-quantity">
                                  <span class="quantity-badge"><%= combo_item.cantidad %>x</span>
                                </div>
                                <p class="combo-item-description">
                                  <%= combo_item.product.descripcion.present? ? truncate(combo_item.product.descripcion, length: 80) : "Componente del combo" %>
                                </p>
                              </div>
                            </div>
                          <% end %>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function copyOrderCode() {
    const codigo = document.getElementById('order-code').innerText;
    navigator.clipboard.writeText(codigo).then(() => {
        // Usar el sistema de alertas premium
        if (window.createFlashAlert) {
            window.createFlashAlert(`C√≥digo copiado: ${codigo}`, 'success', 3000);
        } else {
            alert("C√≥digo copiado: " + codigo);
        }
    }).catch(err => {
        console.error("Error al copiar: ", err);
        if (window.createFlashAlert) {
            window.createFlashAlert('Error al copiar el c√≥digo', 'error', 3000);
        } else {
            alert("Error al copiar el c√≥digo");
        }
    });
}

function toggleComboDetails(index) {
    const details = document.getElementById(`combo-details-${index}`);
    const button = details.previousElementSibling.querySelector('.toggle-combo');
    const arrow = button.querySelector('.toggle-arrow');
    const text = button.querySelector('.toggle-text');
    
    if (details.style.display === 'none') {
        details.style.display = 'block';
        arrow.style.transform = 'rotate(180deg)';
        text.textContent = 'Ocultar componentes';
        
        // Animaci√≥n de aparici√≥n
        details.style.opacity = '0';
        details.style.transform = 'translateY(-10px)';
        setTimeout(() => {
            details.style.transition = 'all 0.3s ease';
            details.style.opacity = '1';
            details.style.transform = 'translateY(0)';
        }, 10);
    } else {
        details.style.transition = 'all 0.3s ease';
        details.style.opacity = '0';
        details.style.transform = 'translateY(-10px)';
        
        setTimeout(() => {
            details.style.display = 'none';
            arrow.style.transform = 'rotate(0deg)';
            text.textContent = 'Ver componentes';
        }, 300);
    }
}

// Inicializar efectos al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    // Animaci√≥n de entrada para las tarjetas de productos
    const productItems = document.querySelectorAll('.product-item');
    productItems.forEach((item, index) => {
        item.style.opacity = '0';
        item.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            item.style.transition = 'all 0.5s ease';
            item.style.opacity = '1';
            item.style.transform = 'translateY(0)';
        }, index * 100);
    });
});
</script>